## 在容器中使用easy_fix

### 准备好基础环境

```sh
root@MSI:/# mkdir ef
root@MSI:/# docker run --name ef -itd --network host -v /ef:/root ubuntu:latest tail -f /dev/null
06fa870b037b2985e95b8fb225d84090cc94d5480846aabd0e3e37f7b1d706cc

apt update
apt install curl wget net-tools vim git make yq

git config --global credential.helper store

#git配置好账号密码
```

### 安装osc

```sh
#apt install osc不能正常使用，所以需要自己克隆代码进行安装
git clone https://github.com/openSUSE/osc.git --depth 1
cd osc
chmod +x setup.py
./setup.py build
root@yyjeqhc:~/git/osc# ./setup.py build
Traceback (most recent call last):
  File "/root/git/osc/./setup.py", line 4, in <module>
    import setuptools
ModuleNotFoundError: No module named 'setuptools'
#缺少包就安装包
apt install python3-setuptools
./setup.py install
```

#### 配置osc

```sh
root@MSI:~/git/obs-build# osc config

Your user account / password are not configured yet.
You will be asked for them below, and they will be stored in
/root/.config/osc/oscrc for future use.

Creating osc configuration file /root/.config/osc/oscrc ...
Username [api.opensuse.org]: yyjeqhc
Password [yyjeqhc@api.opensuse.org]:

NUM NAME              DESCRIPTION
1   Transient         Do not store the password and always ask for it [secure, in-memory]
2   Obfuscated config Store the password in obfuscated form in the osc config file [insecure, persistent]
3   Config            Store the password in plain text in the osc config file [insecure, persistent]
Select credentials manager [default=1]: 3
done
Too few arguments

#不用管url，直接设置好账号密码
[root@localhost ~]# vim /root/.config/osc/oscrc
#默认是这样
···
apiurl=https://api.opensuse.org

[https://api.opensuse.org]
···
#替换为下面的
···
apiurl = https://build.tarsier-infra.isrc.ac.cn/
no_verify = 1

[https://build.tarsier-infra.isrc.ac.cn]

#验证一下
root@MSI:~/git/obs-build#  osc list home:yyjeqhc:branches:openEuler:24.03:SP1:Epol
chromium
gnome-disk-utility
rust-bindgen
```

### 安装ccb

```sh
wget https://gitee.com/src-openeuler/ccb/raw/master/ccb-1.0.1.tar.gz

tar -zxvf ccb-1.0.1.tar.gz

#下载Makefile，然后进行安装
wget https://raw.githubusercontent.com/yyjeqhc/oe_ccb/master/Makefile

root@MSI:~/ccb-1.0.1# make install
Installing ccb to /usr/local/lib/ccb...
# 1. Create main installation directory
install -d "/usr/local/lib/ccb"
# 2. Copy application files (lib, sbin, tests, etc.)
# Using 'cp -r' to copy directories.
cp -r lib sbin tests LICENSE "/usr/local/lib/ccb/"
# 3. Create the sbin directory for the symlink
install -d "/usr/local/sbin"
# 4. Create the symbolic link for the main executable
ln -sf "/usr/local/lib/ccb/sbin/cli/ccb" "/usr/local/sbin/ccb"
Installation complete.

--- IMPORTANT POST-INSTALLATION STEP ---
To make environment settings available in your shell,
add the following line to your shell's startup file
(e.g., ~/.bashrc, ~/.zshrc):

  source /usr/local/lib/ccb/lib/env.sh
  
#貌似不执行也能运行
source /usr/local/lib/ccb/lib/env.sh

#进行配置，输入账号密码，注意如果密码带特殊字符需要使用"password"这样的
vim ~/.config/cli/defaults/config.yaml

#安装一些依赖
apt install ruby ruby-rest-client curl wget docker-cli patch

#验证安装成功
root@MSI:~/ccb-1.0.1# ccb ls -p openEuler-24.03-LTS-SP1:everything pcre2 -a x86_64
{
  "x86_64": {
    "pcre2": [
      "pcre2-help-10.42-13.oe2403sp1.noarch.rpm",
      "pcre2-debuginfo-10.42-13.oe2403sp1.x86_64.rpm",
      "pcre2-devel-10.42-13.oe2403sp1.x86_64.rpm",
      "pcre2-10.42-13.oe2403sp1.x86_64.rpm",
      "pcre2-debugsource-10.42-13.oe2403sp1.x86_64.rpm",
      "pcre2-10.42-13.oe2403sp1.src.rpm"
    ]
  }
}
```

### 安装easy_fix

```sh
root@MSI:~/git# git clone https://github.com/yyjeqhc/easy_fix
Cloning into 'easy_fix'...
remote: Enumerating objects: 24, done.
remote: Counting objects: 100% (24/24), done.
remote: Compressing objects: 100% (15/15), done.
remote: Total 24 (delta 7), reused 23 (delta 6), pack-reused 0 (from 0)
Receiving objects: 100% (24/24), 26.68 KiB | 26.68 MiB/s, done.
Resolving deltas: 100% (7/7), done.
root@MSI:~/git# cd easy_fix/
root@MSI:~/git/easy_fix# ls
easy_fix.sh  readme.md

#安装
root@MSI:~/git/easy_fix# ./easy_fix.sh install
[INFO] 安装脚本到系统...
[INFO] 脚本已安装到: /usr/local/bin/easy_fix
[INFO] 短命令链接: /usr/local/bin/ef
[INFO] 安装bash自动补全...
[INFO] 自动补全已安装到: /usr/share/bash-completion/completions/ef
[INFO] 请重新加载shell或运行: source /usr/share/bash-completion/completions/ef
[INFO] 现在可以使用 'ef' 或 'easy_fix' 命令
[INFO] 支持Tab键自动补全命令和参数

root@MSI:~/git/easy_fix# which ef
/usr/local/bin/ef
root@MSI:~/git/easy_fix#  source /usr/share/bash-completion/completions/ef
root@MSI:~/git/easy_fix# which ef
/usr/local/bin/ef
```

### 使用

#### 1.使用gen命令生成配置文件并填写： ef gen 

gen命令的作用就是生成配置文件。

```sh
root@MSI:~# mkdir ef_test
root@MSI:~# cd ef_test/
root@MSI:~/ef_test#

root@MSI:~/ef_test# ef gen
[INFO] 在当前目录生成配置文件...
[INFO] 配置文件已生成: .easy_fix.yml
[INFO] 请编辑配置文件，只需设置正确的 git URL 即可
[INFO] 然后运行 'ef init' 初始化项目
root@MSI:~/ef_test# cat .easy_fix.yml
# Easy Fix 批量构建配置文件
# 只需填写一个git URL即可，系统会自动推导包名和基础目录

repository:
  url: "https://gitee.com/your-username/your-repo.git"
  branch: "master"

# 分支列表（初始为空，使用 ef swicth 命令会自动添加）
branches: []

build:
  obs:
    project: "home:your-username:branches:openEuler:24.03:SP2:Everything"
  euler:
    project: "your-username:openEuler-24.03-LTS-SP1:everything"


#填写配置
vim .easy_fix.yml
#我的配置如下
# Easy Fix 批量构建配置文件
# 只需填写一个git URL即可，系统会自动推导包名和基础目录

repository:
  url: "https://gitee.com/yyjeqhc/hostname.git"
  branch: "openEuler-24.03-LTS-SP1"

# 分支列表（初始为空，使用 ef swicth 命令会自动添加）
branches: []

build:
  obs:
    project: "home:yyjeqhc:branches:openEuler:24.03:SP2:Everything"
  euler:
    project: "swjnxyf:openEuler-24.03-LTS-SP1:everything"

```

#### 2.使用init命令来拉取代码： ef init

init命令的作用就是拉取代码，拉取以后，需要手动解压压缩包中需要修改的代码，然后应用修改涉及到的补丁，具体可以看oerv中关于easy_fix工具介绍的视频教程

```sh
root@MSI:~/ef# tree
.
|-- logs
`-- tmp

3 directories, 0 files

root@MSI:~/ef# ef init
[INFO] 加载配置文件: .easy_fix.yml
[INFO] 初始化批量构建项目...
[INFO] 配置验证通过:
  仓库: https://gitee.com/yyjeqhc/hostname.git
  包名: hostname
  基础目录: hostname
  分支: 无
  OBS项目: home:yyjeqhc:branches:openEuler:24.03:SP1:Epol
  EulerMaker项目: swjnxyf:openEuler-24.03-LTS-SP1:everything
[INFO] 设置基准仓库...
[INFO] 克隆基准仓库: https://gitee.com/yyjeqhc/hostname.git
Cloning into 'hostname'...
remote: Enumerating objects: 12, done.
remote: Counting objects: 100% (12/12), done.
remote: Compressing objects: 100% (12/12), done.
remote: Total 12 (delta 0), reused 8 (delta 0), pack-reused 0 (from 0)
Receiving objects: 100% (12/12), 24.13 KiB | 2.19 MiB/s, done.
Initialized empty Git repository in /root/ef/hostname/.gits/
[INFO] 项目初始化完成
[INFO] 请手动解压源码包并打上补丁，然后运行 'easy_fix start'
```

![image-20250823200313996](https://github.com/user-attachments/assets/2ffb44df-04fb-4e0f-accb-c9da61dc9b34)

比如，hostname-rh.patch，这个补丁修改的是Makefile，如果你的修改不涉及makefile，你就不用加载这个补丁。

这里以修改hostname的主程序为例。

![image-20250823200429522](https://github.com/user-attachments/assets/890caea2-1a17-4e38-b0a6-1f7cb8d8fe0f)

5000-fix-memory-leak.patch，这个补丁会修改源代码，所以我们要加载这个补丁。

```sh
#先解压，再应用补丁
root@MSI:~/ef/hostname# tar -zxvf hostname_3.23.tar.gz
hostname/
hostname/COPYRIGHT
hostname/Makefile
hostname/debian/
hostname/debian/changelog
hostname/debian/control
hostname/debian/copyright
hostname/debian/dirs
hostname/debian/rules
hostname/debian/source/
hostname/debian/source/format
hostname/hostname.1
hostname/hostname.c
root@MSI:~/ef/hostname# cd hostname
root@MSI:~/ef/hostname/hostname# patch -p1 < ../5000-fix-memory-leak.patch
patching file hostname.c
patch unexpectedly ends in middle of line
```

准备完毕以后，才继续往下执行。

#### 3.准备基准分支，准备完成后，使用 ef start

##### 这一步的操作，等于用git管理修复包的工作区，也就是.gits的那个git仓库，只不过文件和git clone的仓库在一个地方。利用git的双工作区，实际效果，可以看视频教程。

```sh
#这一步的操作是解压源代码，手动加载你认为需要修改的内容涉及到的补丁，这个目的是基于已有的工作来进行修改。如果不涉及，那么不用管已有的补丁，准备好以后，执行ef start，目的是设置基准仓库

root@MSI:~/ef# ef start
[INFO] 加载配置文件: .easy_fix.yml
[openEuler-24.03-LTS-SP1 (root-commit) 5ac334a] commit as the basic branch
 Committer: root <root@MSI.localdomain>
Your name and email address were configured automatically based
on your username and hostname. Please check that they are accurate.
You can suppress this message by setting them explicitly:

    git config --global user.name "Your Name"
    git config --global user.email you@example.com

After doing this, you may fix the identity used for this commit with:

    git commit --amend --reset-author

 11 files changed, 1432 insertions(+)
 create mode 100644 hostname/COPYRIGHT
 create mode 100644 hostname/Makefile
 create mode 100644 hostname/debian/changelog
 create mode 100644 hostname/debian/control
 create mode 100644 hostname/debian/copyright
 create mode 100644 hostname/debian/dirs
 create mode 100755 hostname/debian/rules
 create mode 100644 hostname/debian/source/format
 create mode 100644 hostname/hostname.1
 create mode 100644 hostname/hostname.c
 create mode 100644 nis-domainname
```

以上的流程只需要新的项目才执行一次，以下的流程可以重复执行。

#### 4.进行工作，ef switch branch_name，创建一个新的工作分支，就可以开始修复了，配置文件会添加创建的分支，如果不存在的话

ef switch 是切换到新的分支，新的分支在基准分支上进行派生，可以确保环境的干净。执行此命令，如果配置文件没有记录此分支，就会修改配置文件里面的分支列表信息。

```sh
root@MSI:~/ef# ef switch fix3
[INFO] 加载配置文件: .easy_fix.yml
[INFO] 切换到分支: fix3
[INFO] 分支 fix3 不在配置中，自动添加到配置文件
[INFO] 分支 fix3 已添加到配置文件
[INFO] 加载配置文件: .easy_fix.yml
Switched to a new branch 'fix3'
[INFO] 主仓库创建新分支: fix3
Switched to a new branch 'fix3'
[INFO] 子仓库创建新分支: fix3
[INFO] 分支切换完成: fix3
```

5. #### 修复工作，然后生成补丁，如果需要的话。ef patch patch_name

   这一步生成补丁，只会针对代码，spec/patch文件的修改，或者压缩包删除/添加是不会被计算的。具体效果，请直接查看配置文件。

```c
#hostname.c，它已经应用了原来的补丁，我们做的操作，就是在default分支添加一行自己的输出，来生成新的补丁。

void
show_name(enum type_t type)
{
	struct addrinfo *res;
	struct addrinfo hints;
	struct ifaddrs *ifa, *ifap;
	char *p;
	int ret;

	/* Handle a few cases specially. */
	switch(type)
	{
		case DEFAULT: 
			p=localhost();
			printf("%s\n", p);
			free(p);
			break;
		case SHORT:
			p = localhost();
			*(strchrnul(p, '.')) = '\0';
			printf("%s\n", p);
			free(p);
			break;
```

修改为如下

```c
show_name(enum type_t type)
{
	struct addrinfo *res;
	struct addrinfo hints;
	struct ifaddrs *ifa, *ifap;
	char *p;
	int ret;

	/* Handle a few cases specially. */
	switch(type)
	{
		case DEFAULT: 
			p=localhost();
			printf("%s\n", p);
			free(p);
			printf("this is for test\n");
			break;
```

修改完毕以后，再执行命令来生成补丁。

```sh
root@MSI:~/ef# ef patch fix.patch
[INFO] 加载配置文件: .easy_fix.yml
[INFO] 生成补丁文件: fix.patch
[INFO] 补丁文件已生成并处理路径: fix.patch
```

![image-20250823201211888](https://github.com/user-attachments/assets/1cebdf5f-a9c0-48a2-aa0b-e78b9bfb59e6)

可以看见新生成了补丁文件，并且就是刚才所做的修改。

要使补丁生效，当然还需要修改spec文件。

![image-20250823201322161](https://github.com/user-attachments/assets/c1da9526-1558-4e5f-950f-9f3032bf151b)

#### 6.提交本次修改，和git commit一样，提交修改

这个操作和git commit类似，后面需要一个提交的message，可以省略，有个默认的

```sh
root@MSI:~/ef# ef commit
[INFO] 加载配置文件: .easy_fix.yml
[INFO] 提交更改: for build
[INFO] 主仓库有更改，准备提交
[fix3 df9e9e2] for build
 Committer: root <root@MSI.localdomain>
Your name and email address were configured automatically based
on your username and hostname. Please check that they are accurate.
You can suppress this message by setting them explicitly:

    git config --global user.name "Your Name"
    git config --global user.email you@example.com

After doing this, you may fix the identity used for this commit with:

    git commit --amend --reset-author

 2 files changed, 14 insertions(+), 1 deletion(-)
 create mode 100644 fix.patch
[INFO] 主仓库更改已提交
[INFO] 子仓库有更改，准备提交
[fix3 a007699] for build
 Committer: root <root@MSI.localdomain>
Your name and email address were configured automatically based
on your username and hostname. Please check that they are accurate.
You can suppress this message by setting them explicitly:

    git config --global user.name "Your Name"
    git config --global user.email you@example.com

After doing this, you may fix the identity used for this commit with:

    git commit --amend --reset-author

 1 file changed, 1 insertion(+)
[INFO] 子仓库更改已提交
[INFO] 提交完成: for build
```

#### 7.推送到git，和在两个平台创建包，并且进行构建 ef push

执行此命令，会在obs和euler平台创建包，然后构建包。

```sh
root@MSI:~/ef# ef push
[INFO] 加载配置文件: .easy_fix.yml
[INFO] 开始推送当前分支到远程仓库
[INFO] 当前分支: fix3
[INFO] 推送分支 fix3 到远程origin并设置上游跟踪...
Enumerating objects: 10, done.
Counting objects: 100% (10/10), done.
Delta compression using up to 32 threads
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 533 bytes | 533.00 KiB/s, done.
Total 4 (delta 2), reused 0 (delta 0), pack-reused 0
remote: Powered by GITEE.COM [1.1.5]
remote: Set trace flag e340be90
remote: Create a pull request for 'fix3' on Gitee by visiting:
remote: https://gitee.com/yyjeqhc/hostname/pull/new/yyjeqhc:fix3...yyjeqhc:master
To https://gitee.com/yyjeqhc/hostname.git
 * [new branch]      fix3 -> fix3
branch 'fix3' set up to track 'origin/fix3'.
[INFO] 分支 fix3 已成功推送并设置上游跟踪
[INFO] 推送操作完成
[INFO] 创建EulerMaker包: hostname-fix3
[INFO] 向项目添加包...
{
  "code": 0,
  "data": "The update operation of the project was successful.",
  "msg": null
}
[INFO] 触发构建...
{
  "code": 0,
  "data": {
    "d3b30712-801a-11f0-8f07-8e9b5bd0024c": {
      "architecture": "aarch64",
      "os_variant": "openEuler:24.03-LTS-SP1"
    },
    "d3b6de64-801a-11f0-8f07-8e9b5bd0024c": {
      "architecture": "x86_64",
      "os_variant": "openEuler:24.03-LTS-SP1"
    }
  },
  "msg": null
}
[INFO] EulerMaker包创建完成: hostname-fix3
[INFO] 创建OBS包: hostname-fix3
fatal: upstream branch 'refs/heads/fix3' not stored as a remote-tracking branch
Sending meta data...
Done.
fatal: upstream branch 'refs/heads/fix3' not stored as a remote-tracking branch
A    home:yyjeqhc:branches:openEuler:24.03:SP1:Epol/hostname-fix3
At revision None.
A    _service
Try env VC_REALNAME=...
Sending    _service
Transmitting file data .
Committed revision 1.
Waiting for server side source service run
...
At revision 1.
[INFO] OBS包创建完成: hostname-fix3
[INFO] OBS和EulerMaker包已创建并开始构建
```

### 8.查询构建状态

```sh
#前面已经创建了一些分支，所以有fix2 fix1
root@MSI:~/ef# ef query-all
[INFO] 加载配置文件: .easy_fix.yml
[INFO] 查询OBS构建状态...
[INFO] 查询OBS包状态: hostname-fix3
standard_riscv64     riscv64    hostname-fix3                  building
---
[INFO] 查询OBS包状态: hostname-fix2
standard_riscv64     riscv64    hostname-fix2                  succeeded*
---
[INFO] 查询OBS包状态: hostname-fix1
standard_riscv64     riscv64    hostname-fix1                  succeeded*
---
[INFO] 查询EulerMaker构建状态...
[hostname-fix3]
aarch64: building
x86_64: 204

[hostname-fix2]
aarch64: succeeded
x86_64: succeeded

[hostname-fix1]
aarch64: succeeded
x86_64: succeeded

#下面是测试其他包的执行输出
#后面可跟参数，无参数就是全部分支
root@MSI:~/ef_test# ef query-obs
[INFO] 加载配置文件: .easy_fix.yml
[INFO] 查询OBS构建状态...
[INFO] 查询OBS包状态: hello-world-fix1
standard_riscv64     riscv64    hello-world-fix1               building
---

#后面可跟参数，无参数就是全部分支
root@MSI:~/ef_test# ef query-euler fix1
[INFO] 加载配置文件: .easy_fix.yml
[INFO] 查询EulerMaker构建状态...
[hello-world-fix1]
aarch64: failed
x86_64: failed

#查看两个平台，所有分支的构建状态
root@MSI:~/ef_test# ef query-all
[INFO] 加载配置文件: .easy_fix.yml
[INFO] 查询OBS构建状态...
[INFO] 查询OBS包状态: hello-world-fix1
standard_riscv64     riscv64    hello-world-fix1               building
---
[INFO] 查询EulerMaker构建状态...
[hello-world-fix1]
aarch64: failed
x86_64: failed
```

#### 总结：前面3步，是修复一个包的基础过程，后面4 5 6 7 8 都是可以重复的。

#### 使用场景：提交并构建了fix1分支，现在你有新的思路，可以ef switch fix2，在完全干净的环境中进行修复，然后一样的流程。可以重复多次，同时构建多个版本的补丁包。

并且，可以在git网站进行查看，使用ef提交的修改，和手动修改提交推送是一样的，只是现在推送，创建包，构建包一步操作，不需要推送后再打开浏览器，打开网页进行繁琐的操作了。

### 9.验证修改

```sh
#可以查看构建产物，release号可以看出来是我们提交的修改
root@MSI:~/tef# ccb ls -p swjnxyf:openEuler-24.03-LTS-SP1:everything hostname -a x86_64
{
  "x86_64": {
    "hostname": [
      "hostname-3.23-3.oe2403sp1.x86_64.rpm",
      "hostname-debugsource-3.23-3.oe2403sp1.x86_64.rpm",
      "hostname-debuginfo-3.23-3.oe2403sp1.x86_64.rpm",
      "hostname-3.23-3.oe2403sp1.src.rpm"
    ]
  }
}

#利用ccb下载构建的包
root@MSI:~/tef# ccb download os_project=swjnxyf:openEuler-24.03-LTS-SP1:everything packages=hostname architecture=x86_64

Downloading rpms to: ./swjnxyf:openEuler-24.03-LTS-SP1:everything-x86_64-hostname
        - hostname-3.23-3.oe2403sp1.src.rpm
        - hostname-debuginfo-3.23-3.oe2403sp1.x86_64.rpm
        - hostname-debugsource-3.23-3.oe2403sp1.x86_64.rpm
        - hostname-3.23-3.oe2403sp1.x86_64.rpm

root@MSI:~/tef# cd swjnxyf\:openEuler-24.03-LTS-SP1\:everything-x86_64-hostname/
root@MSI:~/tef/swjnxyf:openEuler-24.03-LTS-SP1:everything-x86_64-hostname# ls
hostname-3.23-3.oe2403sp1.src.rpm     hostname-debuginfo-3.23-3.oe2403sp1.x86_64.rpm
hostname-3.23-3.oe2403sp1.x86_64.rpm  hostname-debugsource-3.23-3.oe2403sp1.x86_64.rpm

#解压出可执行文件来执行
root@MSI:~/tef/swjnxyf:openEuler-24.03-LTS-SP1:everything-x86_64-hostname# rpm2cpio ./hostname-3.23-3.oe2403sp1.x86_64.rpm | cpio -idmv
./etc/ima/digest_lists.tlv/0-metadata_list-compact_tlv-hostname-3.23-3.oe2403sp1.x86_64
./etc/ima/digest_lists/0-metadata_list-compact-hostname-3.23-3.oe2403sp1.x86_64
./usr/bin/dnsdomainname
./usr/bin/domainname
./usr/bin/hostname
./usr/bin/nisdomainname
./usr/bin/ypdomainname
./usr/lib/systemd/system/nis-domainname.service
./usr/libexec/hostname/nis-domainname
./usr/share/doc/hostname
./usr/share/doc/hostname/COPYRIGHT
./usr/share/licenses/hostname
./usr/share/licenses/hostname/gpl-2.0.txt
./usr/share/man/man1/dnsdomainname.1.gz
./usr/share/man/man1/domainname.1.gz
./usr/share/man/man1/hostname.1.gz
./usr/share/man/man1/nisdomainname.1.gz
./usr/share/man/man1/ypdomainname.1.gz
104 blocks

root@MSI:~/tef/swjnxyf:openEuler-24.03-LTS-SP1:everything-x86_64-hostname# ./usr/bin/hostname
MSI
this is for test
```

